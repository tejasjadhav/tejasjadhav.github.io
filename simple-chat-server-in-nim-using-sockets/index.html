<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.2 'Libre Baskerville',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'Libre Baskerville',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;color:hsla(0,0%,0%,1);font-family:'Raleway',sans-serif;font-weight:800;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;color:hsla(0,0%,0%,1);font-family:'Raleway',sans-serif;font-weight:800;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;color:hsla(0,0%,0%,1);font-family:'Raleway',sans-serif;font-weight:800;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;color:hsla(0,0%,0%,1);font-family:'Raleway',sans-serif;font-weight:800;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;color:hsla(0,0%,0%,1);font-family:'Raleway',sans-serif;font-weight:800;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;color:hsla(0,0%,0%,1);font-family:'Raleway',sans-serif;font-weight:800;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}ul{margin-left:1.2rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.2rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;font-size:0.85rem;line-height:1.2rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;font-size:18;line-height:1.8rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}blockquote{margin-left:0.8rem;margin-right:0.8rem;margin-top:0.8rem;padding-bottom:0;padding-left:0.8rem;padding-right:0;padding-top:0;margin-bottom:0.8rem;color:hsla(0,0%,0%,0.7340000000000001);border-left:4px solid #999;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(0.8rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.2rem;margin-bottom:calc(0.8rem / 2);margin-top:calc(0.8rem / 2);}li > ul{margin-left:1.2rem;margin-bottom:calc(0.8rem / 2);margin-top:calc(0.8rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8rem / 2);}code{font-size:0.85rem;line-height:1.2rem;}kbd{font-size:0.85rem;line-height:1.2rem;}samp{font-size:0.85rem;line-height:1.2rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:0.8rem;padding-right:0.8rem;padding-top:0.6rem;padding-bottom:calc(0.6rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}@media only screen and (max-width:480px){html{font-size:80%;line-height:19.2px;}}a{font-weight:bold;color:#00f;text-decoration:none;}a:hover{text-decoration:underline;}</style><style data-href="/styles.0da9468f2557c73b37a8.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.command-line-prompt{border-right:1px solid #999;display:block;float:left;font-size:100%;letter-spacing:-1px;margin-right:1em;pointer-events:none;-webkit-user-select:none;-ms-user-select:none;user-select:none}.command-line-prompt>span:before{color:#999;content:" ";display:block;padding-right:.8em}.command-line-prompt>span[data-user]:before{content:"[" attr(data-user) "@" attr(data-host) "] $"}.command-line-prompt>span[data-user=root]:before{content:"[" attr(data-user) "@" attr(data-host) "] #"}.command-line-prompt>span[data-prompt]:before{content:attr(data-prompt)}.gatsby-highlight-code-line{background-color:#feb;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:.75em;border-left:.25em solid #f99}.gatsby-highlight{background-color:#fdf6e3;margin:.5em 0;padding:1em;overflow:auto;border:2px solid #dfa700}.gatsby-highlight pre[class*=language-]{background-color:transparent;margin:0;padding:0;overflow:initial;float:left;min-width:100%}.gatsby-highlight pre[class*=language-].line-numbers{padding-left:2.8em}.gatsby-code-title{margin-bottom:-.6rem;padding:.25em 1em;font-size:.9em;font-weight:700;font-family:Consolas,Roboto Mono,Liberation Mono,Menlo,Courier,monospace;background-color:#dfa700;z-index:0}code,code[class*=language-],pre,pre[class*=language-],table.monospace{font-family:Consolas,Roboto Mono,Liberation Mono,Menlo,Courier,monospace;line-height:1.1;font-size:.95em}@media (prefers-color-scheme:dark){:not(pre)>code[class*=language-]{color:#fff;background-color:#333;text-shadow:none}.line-numbers-rows,pre>code[class*=language-]{color:#fff;text-shadow:none}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background-color:transparent}.gatsby-highlight,.gatsby-highlight-code-line{background-color:#000}.gatsby-highlight{border-color:#1e8eba}.gatsby-code-title{background-color:#1e8eba;color:#fff}}@media (prefers-color-scheme:dark){body,html{background-color:#000}blockquote,body,h1,h2,h3,h4,h5,h6,html{color:#fff}a{color:#fb7979}hr{background-color:#fff}}</style><meta name="generator" content="Gatsby 2.20.25"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/icons/icon-48x48.png?v=c7e4d8cf5ea7282a6913c3666c22c4c6"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=c7e4d8cf5ea7282a6913c3666c22c4c6"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=c7e4d8cf5ea7282a6913c3666c22c4c6"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=c7e4d8cf5ea7282a6913c3666c22c4c6"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=c7e4d8cf5ea7282a6913c3666c22c4c6"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=c7e4d8cf5ea7282a6913c3666c22c4c6"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=c7e4d8cf5ea7282a6913c3666c22c4c6"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=c7e4d8cf5ea7282a6913c3666c22c4c6"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=c7e4d8cf5ea7282a6913c3666c22c4c6"/><title data-react-helmet="true">Simple chat server in Nim: Basics • Tejas Jadhav</title><meta data-react-helmet="true" name="description" content="Build a simple chat server using nothing except sockets in Nim which pushes messages sent by any client to all other connected clients. Since I&#x27;m at home now…"/><meta data-react-helmet="true" property="og:title" content="Simple chat server in Nim: Basics"/><meta data-react-helmet="true" property="og:description" content="Build a simple chat server using nothing except sockets in Nim which pushes messages sent by any client to all other connected clients. Since I&#x27;m at home now…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="_tejasjadhav"/><meta data-react-helmet="true" name="twitter:title" content="Simple chat server in Nim: Basics"/><meta data-react-helmet="true" name="twitter:description" content="Build a simple chat server using nothing except sockets in Nim which pushes messages sent by any client to all other connected clients. Since I&#x27;m at home now…"/><link href="//fonts.googleapis.com/css?family=Raleway:800|Libre+Baskerville:400,400i,700" rel="stylesheet" type="text/css"/><link as="script" rel="preload" href="/webpack-runtime-90fe9894775700252564.js"/><link as="script" rel="preload" href="/framework-c88d07efb40e009babfb.js"/><link as="script" rel="preload" href="/styles-1c3c06048fccead674b8.js"/><link as="script" rel="preload" href="/app-fc4d0f0a2c7f65435551.js"/><link as="script" rel="preload" href="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-baf100a1121eb9646ed4.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-0de9500dca1e6e690244.js"/><link as="fetch" rel="preload" href="/page-data/simple-chat-server-in-nim-using-sockets/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:57.6rem;padding:1.8rem 0.9rem"><header><h3 style="margin-top:0"><a style="box-shadow:none;color:inherit" href="/">Tejas Jadhav</a></h3></header><main><article><header><h1 style="margin-top:1.2rem;margin-bottom:0">Simple chat server in Nim: Basics</h1><p style="font-size:0.87055rem;line-height:1.2rem;display:block;margin-bottom:1.2rem">January 24, 2019</p></header><p>Build a simple chat server using nothing except sockets in Nim which pushes messages sent by any client to all other connected clients.</p><p>Since I’m at home now, on a break, not really doing anything, I decided to learn this new programming language called <a href="https://nim-lang.org/">Nim</a> which is a perfect fusion between the elegance of Python and performance of C. What’s better way to start with a language than actually creating something meaningful? So, I decided to not only create a simple chat server, but also write a step-by-step tutorial about it.</p><h1>Prerequisites</h1><ul><li>Install Nim compiler. You can get the download links or installation commands from their <a href="https://nim-lang.org/install.html">installation page</a>. The compiler version in this tutorial is 0.18.0, though newer versions should not have any issue.</li><li>Get Nim plugins for your editor. Again you can refer to the <a href="https://github.com/nim-lang/Nim/wiki/Editor-Support">editor plugins page</a> on their <a href="https://github.com/nim-lang/Nim/wiki/">GitHub wiki</a>.</li></ul><h1>Problem statement</h1><blockquote><p>Our chat server will be a single room (channel) chat where anyone can talk with everyone. When a user types in a message, it is sent to all other users connected to the chat server.</p></blockquote><p>In any chat application, the core responsibility of a server is just to act as a relay and send messages from one client to the other. The server should be sufficiently fast enough to accept newer clients who join, read messages from the clients, broadcast those messages to all other clients, without showing any noticeable delay for any of the clients. This would truly make it an instant messaging platform.</p><h1>I. Plan</h1><p>We need a <a href="https://www.techopedia.com/definition/7154/full-duplex-fdx">full duplex</a> link between the server and the client so that messages can be sent and received at the same time. Of all the various methods like <a href="https://realtimeapi.io/hub/http-long-polling/">long-polling</a>, <a href="https://en.wikipedia.org/wiki/BOSH_(protocol)">BOSH</a>, <a href="https://en.wikipedia.org/wiki/Comet_(programming)">comet</a>, my recommendation is to use <a href="https://www.tutorialspoint.com/unix_sockets/what_is_socket.htm">sockets</a> (<a href="https://www.html5rocks.com/en/tutorials/websockets/basics/">web sockets</a> for <a href="https://caniuse.com/#feat=websockets">browsers</a>). They are truly bi-directional, light-weight and efficient for such use cases.</p><ol><li>Our server would act as a socket server.</li><li>It would bind to a specific port and IP address and listen for new socket connections.</li><li>For every socket connected, it would add it to it’s active socket connections list.</li><li>When any connected socket sends a message to the server, the server will send it to all the sockets in the active socket connections list (except the one who sent it).</li><li>If a connected socket closes connection, the server will remove it from the active list.</li></ol><h1>II. Getting started</h1><p>Create a directory in your projects folder (or wherever you want) called <code class="language-text">simple-chat-server</code>. You might want to open this directory in your code editor. <strong>All path references here on will be relative to this directory.</strong></p><p>Create a file called <code class="language-text">server.nim</code>. This would be our core server file. To compile and run the code in this file, we will use <code class="language-text">nim compile --run server.nim</code>.</p><p>We’ll create a simple socket which will listen to new socket connections on port <code class="language-text">5555</code> and then close it.</p><div class="gatsby-code-title">server.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">let</span> server<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">bindAddr</span><span class="token punctuation">(</span><span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: started. Listening to new connections on port 5555...&quot;</span><span class="token punctuation">)</span>

server<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h4>Explanation</h4><blockquote><p><strong>1</strong> All socket related functions, classes, utilities are in the <a href="https://nim-lang.org/docs/net.html"><code class="language-text">net</code></a> package. We could have also used <a href="https://nim-lang.org/docs/nativesockets.html"><code class="language-text">nativesockets</code></a> package which is exclusively for sockets. But it handles sockets at very low-level which might just lengthen our code.</p><p><strong>3</strong> Initialize our server socket using <a href="https://nim-lang.org/docs/net.html#newSocket,Domain,SockType,Protocol"><code class="language-text">newSocket</code></a>. This function also accepts some parameters which we will discuss in-depth later. For now, we are okay leaving it to the default values.</p><p><strong>4-5</strong> Set the socket to listen to new connections on port <code class="language-text">5555</code> and start accepting new connections from other sockets. If <a href="https://nim-lang.org/docs/net.html#bindAddr,Socket,string"><code class="language-text">address</code> parameter</a> is not mentioned by default, the socket will listen to requests from all IP addresses.</p><p><strong>8</strong> Close our socket server. It is very important to close socket connections if they are no longer required. This is considered a clean way to end TCP connections with proper end-of-connection acknowledgement.</p></blockquote><p>To run the above code, we need to compile it first and then execute the binary. Fortunately, the Nim compiler can do both in a single command by specifying the <code class="language-text">--run</code> or <code class="language-text">-r</code> argument.
The compiler pulls all the required packages along with <code class="language-text">server.nim</code>, transpiles them into C, links the libraries and creates an executable binary file with the same name as our file sans the file extension (in our case it becomes <code class="language-text">server</code>) in the root of the project directory.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>nim compile --run server.nim
Hint: used config <span class="token function">file</span> <span class="token string">&#x27;/etc/nim.cfg&#x27;</span> <span class="token punctuation">[</span>Conf<span class="token punctuation">]</span>
Hint: system <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: server <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: net <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: nativesockets <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: os <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: strutils <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: parseutils <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: math <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: algorithm <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: <span class="token builtin class-name">times</span> <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: posix <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: ospaths <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: options <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: typetraits <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: sets <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
Hint: hashes <span class="token punctuation">[</span>Processing<span class="token punctuation">]</span>
CC: server
CC: stdlib_system
CC: stdlib_net
Hint:  <span class="token punctuation">[</span>Link<span class="token punctuation">]</span>
Hint: operation successful <span class="token punctuation">(</span><span class="token number">26847</span> lines compiled<span class="token punctuation">;</span> <span class="token number">0.903</span> sec total<span class="token punctuation">;</span> <span class="token number">47</span>.43MiB peakmem<span class="token punctuation">;</span> Debug Build<span class="token punctuation">)</span> <span class="token punctuation">[</span>SuccessX<span class="token punctuation">]</span>
Hint: /home/tejas/Projects/simple-chat-server/server  <span class="token punctuation">[</span>Exec<span class="token punctuation">]</span></code></pre></div><p>The code ran but it didn’t produce any output, except for compiler messages (we will be omitting compiler messages hereon). The server created the socket, listened for incoming connections and closed the socket connection.</p><p>Now we’ll make the server wait until it receives new connections.</p><div class="gatsby-code-title">server.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">let</span> server<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">bindAddr</span><span class="token punctuation">(</span><span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: started. Listening to new connections on port 5555...&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Socket<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">accept</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client connected&quot;</span><span class="token punctuation">)</span>

server<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span></span>nim compile --run server.nim
Server: started. Listening to new connections on port <span class="token number">5555</span><span class="token punctuation">..</span>.</code></pre></div><p>Our server is now actively listening for connections from clients. But… it’s kinda stuck there because the server is waiting for a client to connect. We’ll have to create one now.</p><p>Create a new file called <code class="language-text">client.nim</code>. We’ll use socket as a client and connect to the server.</p><div class="gatsby-code-title">client.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">let</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token operator">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Client: connected to server on address 127.0.0.1:5555&quot;</span><span class="token punctuation">)</span>

client<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h4>Explanation</h4><blockquote><p><strong>3-4</strong> Similar to the server, we need a socket object. The only difference here is, unlike server, which listens to connections, a client knows the server address and connects to it using the <a href="https://nim-lang.org/docs/net.html#connect,Socket,string"><code class="language-text">connect</code></a> method. Thus, a client needs to have the address and port of the server.</p></blockquote><p>Execute <code class="language-text">server.nim</code> and at the same time, in a new terminal window/tab, execute <code class="language-text">client.nim</code>.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span></span>nim compile --run server.nim
Server: started. Listening to new connections on port <span class="token number">5555</span><span class="token punctuation">..</span>.
Server: client connected</code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span></span>nim compile --run client.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555</code></pre></div><p>The server started and waited for connections. The moment we started the client, it connected to our socket server on the specified address. Server received this connection and assigned the client to the <code class="language-text">client</code> variable, and closed the socket.</p><p>This was a barebones socket server and client. We have to add the real magic - sending and receiving messages.</p><h1>III. Sending and receiving messages</h1><p>A socket on an OS is a file descriptor (layman: just a file). When we say that a socket received some data, it actually signifies that some data was written on that file descriptor.</p><p>We have built a server which accepts socket connection and a client which connects to the server. Now, we’ll dive into the actual communication between client and server.</p><p>On the client side, we’ll prompt user to enter the message to be sent and then send this message over to the server.</p><div class="gatsby-code-title">client.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">let</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token operator">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Client: connected to server on address 127.0.0.1:5555&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  stdout<span class="token operator">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> message<span class="token operator">:</span> string <span class="token operator">=</span> stdin<span class="token operator">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  client<span class="token operator">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>

client<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h5>Explanation</h5><blockquote><p><strong>7</strong> Once the user sends a message, we’ll prompt for another message, sort of how chat applications provide a text box to send a message.</p><p><strong>8-10</strong> Prompt the user for a chat message and using the client socket, <a href="https://nim-lang.org/docs/net.html#send,Socket,string"><code class="language-text">send</code></a> it to the server. Also, we are using <a href="https://nim-lang.org/docs/system.html#readLine,File"><code class="language-text">readLine</code></a> so that the messsage gets stored only when user presses <kbd>Enter</kbd>.</p></blockquote><p>On the server side, we need to listen to new messages from client. We’ll also print the messages received from the client on the console.</p><div class="gatsby-code-title">server.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">var</span> server<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">bindAddr</span><span class="token punctuation">(</span><span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: started. Listening to new connections on port 5555...&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Socket<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">accept</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client connected&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  <span class="token keyword">let</span> message<span class="token operator">:</span> string <span class="token operator">=</span> client<span class="token operator">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> message <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token operator">:</span>
    <span class="token keyword">break</span>

  stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: received from client: &quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

server<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h4>Explanation</h4><blockquote><p><strong>12</strong> Server will keep listening to new messages from all connected clients.</p><p><strong>13</strong> Read a few characters from the socket.</p><p><strong>15-16</strong> When a socket disconnects, it sends an empty string before disconnection. This can be used as an indication for the server that the client has disconnected. Since we are dealing with only one client, we’ll stop receiving additional messages and exit the loop.</p><p><strong>18</strong> Print the received message on the console.</p></blockquote><p>Let’s execute both <code class="language-text">server.nim</code> and <code class="language-text">client.nim</code> in two different terminal tabs/windows. Note that I have used <code class="language-text">nim c -r</code> which is a shorthand for <code class="language-text">nim compile --run</code>.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span></span>nim c -r client.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555
<span class="token operator">&gt;</span> Hello, world
<span class="token operator">&gt;</span> Lorem ipsum dolor sit amet, consectetur adipiscing elit.
<span class="token operator">&gt;</span></code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>nim c -r server.nim
Server: started. Listening to new connections on port <span class="token number">5555</span><span class="token punctuation">..</span>.
Server: client connected
Server: received from client: Hello, wor
Server: received from client: ldLorem <span class="token function">ip</span>
Server: received from client: <span class="token function">sum</span> dolor
Server: received from client: sit amet,
Server: received from client: consectetu
Server: received from client: r adipisci</code></pre></div><p>Something’s gone horribly wrong here. Not only our client messages are truncated, but they are also mingled with other messages. We sent <em>Hello, world</em> and <em>Lorem ipsum dolor sit amet, consectetur adipiscing elit</em>. as two different messages, but on the server side we’re getting them in sort of mingled fashion. Also, our second message is incomplete.</p><p>The culprit here is line 13. We specified that we’ll only accept 10 characters from the socket. Also, until socket does not have at least 10 characters in its buffer, the <a href="https://nim-lang.org/docs/net.html#recv,Socket,int"><code class="language-text">recv</code></a> function will keep blocking indefinitely. The socket will keep reading messages until it has reached that count in its buffer and only then it will return the data. We can do the following,</p><ol><li>We’ll use some delimiting character. We’ll read a very small amount of data from the socket and scan all characters in it and store it in our own buffer. If we encounter the delimiting character while scanning, we’ll stop there, dump whatever we read so far in the buffer and return the buffer data.</li><li>We can also use the <code class="language-text">timeout</code> parameter in the <a href="https://nim-lang.org/docs/net.html#recv,Socket,int"><code class="language-text">recv</code></a>. By default, the timeout value is <code class="language-text">-1</code>, which means we will wait indefinitely until there is enough data in the socket. We can set it to a small amount so that we don’t wait indefinitely for new messages.</li></ol><p>A much better solution here would be to use the <a href="https://nim-lang.org/docs/net.html#recvLine,Socket"><code class="language-text">recvLine</code></a> method. It handles the complexity of handling the delimited character for us. It uses <code class="language-text">\r\L</code> as the delimiter. This means, on the client side, for each message we send, we would also need to append this delimiter. Let’s make the changes accordingly.</p><div class="gatsby-code-title">server.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">var</span> server<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">bindAddr</span><span class="token punctuation">(</span><span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: started. Listening to new connections on port 5555...&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Socket<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">accept</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client connected&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  <span class="token keyword">let</span> message<span class="token operator">:</span> string <span class="token operator">=</span> client<span class="token operator">.</span><span class="token function">recvLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> message <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token operator">:</span>
    <span class="token keyword">break</span>

  stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: received from client: &quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

server<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><div class="gatsby-code-title">client.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">let</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token operator">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Client: connected to server on address 127.0.0.1:5555&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  stdout<span class="token operator">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> message<span class="token operator">:</span> string <span class="token operator">=</span> stdin<span class="token operator">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  client<span class="token operator">.</span><span class="token function">send</span><span class="token punctuation">(</span>message <span class="token operator">&amp;</span> <span class="token string">&quot;\r\L&quot;</span><span class="token punctuation">)</span>

client<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>If the server and client are still running, kill the processes with <kbd>Ctrl</kbd>+<kbd>C</kbd>. Execute <code class="language-text">server.nim</code> and <code class="language-text">client.nim</code> again.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span><span></span></span>nim c -r server.nim
server.nim<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>            server
net.nim<span class="token punctuation">(</span><span class="token number">738</span><span class="token punctuation">)</span>             bindAddr
oserr.nim<span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">)</span>           raiseOSError
Error: unhandled exception: Address already <span class="token keyword">in</span> use <span class="token punctuation">[</span>OSError<span class="token punctuation">]</span>
Error: execution of an external program failed: &#x27;/home/tejas/Projects/simple-chat-server/server</code></pre></div><p>If you’re getting the above error, it’s an indication that the port on which our server listens is being reserved for some reason. It happens when some process which is listening on that port is still running. Though in our case, even though we stopped the server, it’s still giving us this error. The reason here is something called as <em>Linger Time</em>. When a socket is closed (especially TCP socket), some data which is marked to be sent, still exists in the socket’s send buffer. Unless the buffer is emptied or a timeout period (usually 30 seconds) is passed, the system reserves the port.</p><p>To fix this, we use the <code class="language-text">SO_REUSEADDR</code> property of sockets. If a socket is created with this option enabled, instead of throwing an error, it checks whether a socket which is listening on the same port is in lingering state. If it is, the socket will use the same address with an assumption that the earlier socket will release the port soon. In Nim, we have the <code class="language-text">OptReuseAddr</code> option which can be set as <code class="language-text">true</code> to enable <code class="language-text">SO_REUSEADDR</code> property of the socket.</p><div class="gatsby-code-title">server.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">var</span> server<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">setSockOpt</span><span class="token punctuation">(</span>OptReuseAddr<span class="token punctuation">,</span> true<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">bindAddr</span><span class="token punctuation">(</span><span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: started. Listening to new connections on port 5555...&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Socket<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">accept</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client connected&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  <span class="token keyword">let</span> message<span class="token operator">:</span> string <span class="token operator">=</span> client<span class="token operator">.</span><span class="token function">recvLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> message <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token operator">:</span>
    <span class="token keyword">break</span>

  stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: received from client: &quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

server<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>Let’s run the server and clients again.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span><span data-user="tejas" data-host="localhost"></span></span>nim c -r server.nim
Server: started. Listening to new connections on port <span class="token number">5555</span><span class="token punctuation">..</span>.
Server: client connected
Server: received from client: Hello, world
Server: received from client: Lorem ipsum dolor sit amet, consectetur adipiscing elit.
</code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span data-user="tejas" data-host="localhost"></span></span>nim c -r client.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555
<span class="token operator">&gt;</span> Hello, world
<span class="token operator">&gt;</span> Lorem ipsum dolor sit amet, consectetur adipiscing elit.
<span class="token operator">&gt;</span></code></pre></div><p>As you can see now, the messages are no longer truncated and they are received in the same manner as sent by the client.</p><p>Now that we have spawned our basic server which accepts messages from a client, let’s spawn another client and see what happens. Don’t kill the currently running <code class="language-text">server.nim</code> and <code class="language-text">client.nim</code> and instead run <code class="language-text">client.nim</code> again in a new tab/terminal and send a few messages.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span></span>nim c -r client.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555
<span class="token operator">&gt;</span> Hola, mundo
<span class="token operator">&gt;</span> What&#x27;s <span class="token number">1</span> + <span class="token number">1</span>? Answer is <span class="token number">10</span> <span class="token keyword">in</span> binary.
<span class="token operator">&gt;</span></code></pre></div><p>If you check the tab/terminal running our server, you wouldn’t find these messages at all. The server did not receive any message at all from our new client. Can you identify the problem?</p><p>Notice the lines 9-11, where we wait and accept connection from a client. The moment a client connects, we never again accept and listen to data from new clients. As soon as we get a client, we just listen to new data from that client. What we can do is, as we listen to new data from one client, we’ll also accept new connections from other clients. Our flow would go like this,</p><ol><li>Have an infinte loop (<code class="language-text">while true</code>) which will keep our server running.</li><li>Inside the loop, accept new client connections and add those into our client list.</li><li>For each client in the client list, check if there is any data.</li><li>If there is any data, print it out.</li></ol><p>However, there is a slight problem in step 2. In our server socket, as seen here, the server will block the program flow while it is listening for new clients since <code class="language-text">server.accept()</code> is a blocking function. Thus our messages will only be read once a client connects to the server. This is not even an acceptable case for our chat server.</p><p>Fortunately, sockets have an option to run in non-blocking mode. This means, our <code class="language-text">accept()</code> and <code class="language-text">recv()</code> functions will no longer block the code. If they have anything meaningful to return (like an incoming socket connection or a message), they will return that and continue execution. Otherwise, they will throw an error. Which means, we have to keep checking for new connections or messages and also handle the error in case we don’t get any.</p><p>In Nim, we enable non-blocking mode using the <a href="https://nim-lang.org/docs/nativesockets.html#setBlocking,SocketHandle,bool"><code class="language-text">setBlocking()</code></a> function of the underlying native socket. We’ll also store all our connected sockets in a list so that we can iterate over them and receive messages from each of them. We’ll do both, accept new connections and receive data from sockets in a single infinite loop, so that we keep accepting new connections while we receive messages from existing ones. Let’s give this a try.</p><div class="gatsby-code-title">server.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net
<span class="token keyword">import</span> nativesockets

<span class="token keyword">var</span> server<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">setSockOpt</span><span class="token punctuation">(</span>OptReuseAddr<span class="token punctuation">,</span> true<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">setBlocking</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">bindAddr</span><span class="token punctuation">(</span><span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: started. Listening to new connections on port 5555...&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> clients<span class="token operator">:</span> seq<span class="token punctuation">[</span>Socket<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  <span class="token keyword">try</span><span class="token operator">:</span>
    <span class="token keyword">var</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Socket<span class="token punctuation">)</span>
    server<span class="token operator">.</span><span class="token function">accept</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    clients<span class="token operator">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client connected&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">except</span> OSError<span class="token operator">:</span>
    <span class="token keyword">discard</span>

  <span class="token keyword">var</span> clientsToRemove<span class="token operator">:</span> seq<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">for</span> index<span class="token punctuation">,</span> client <span class="token operator">in</span> clients<span class="token operator">:</span>
    <span class="token keyword">try</span><span class="token operator">:</span>
      <span class="token keyword">let</span> message<span class="token operator">:</span> string <span class="token operator">=</span> client<span class="token operator">.</span><span class="token function">recvLine</span><span class="token punctuation">(</span>timeout <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> message <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token operator">:</span>
        clientsToRemove<span class="token operator">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>

      stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: received from client: &quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token keyword">except</span> TimeoutError<span class="token operator">:</span>
        <span class="token keyword">discard</span>

  <span class="token keyword">for</span> index <span class="token operator">in</span> clientsToRemove<span class="token operator">:</span>
    clients<span class="token operator">.</span><span class="token function">del</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
    stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client disconnected&quot;</span><span class="token punctuation">)</span>

server<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h4>Explanation</h4><blockquote><p><strong>6</strong> Set the socket as non-blocking. We set it on the low-level native socket API.</p><p><strong>11</strong> We need to store our connected clients in a list so that we can iterate over them to get messages.</p><p><strong>13-37</strong> Check if there are any existing connections. If yes, add them to the connected socket list. Then for each connected socket, check whether there are any messages to be read.</p><p><strong>17</strong> Add the connected socket in our clients list.</p><p><strong>19</strong> In non-blocking mode, <a href="https://nim-lang.org/docs/net.html#accept,Socket,Socket"><code class="language-text">accept</code></a> throws an <code class="language-text">OSError</code> if there are no pending connections at that moment. We ignore that exception because it’s understandable that we won’t have any pending connections all the time.</p><p><strong>22</strong> We maintain a list of clients which disconnected so that we remove those from our client list.</p><p><strong>24</strong> Iterate over all the connected clients and receive messages from them one by one.</p><p><strong>26</strong> We set the <code class="language-text">timeout</code> to <code class="language-text">1</code> since <a href="https://nim-lang.org/docs/net.html#recvLine,Socket"><code class="language-text">recvLine</code></a> call still blocks the code as the default timeout value is <code class="language-text">-1</code>, which means block indefinitely till message is received.</p><p><strong>29</strong> Mark the client for removal if it has disconnected.</p><p><strong>32</strong> If no message is received within the timeout period, <a href="https://nim-lang.org/docs/net.html#recvLine,Socket"><code class="language-text">recvLine</code></a> throws a <code class="language-text">TimeoutError</code>. Since we are operating in a non-blocking mode now, we shall ignore this error.</p><p><strong>35-37</strong> Remove any client marked for removal from the clients list.</p></blockquote><p>Let’s execute our server now with multiple clients.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span>nim c -r server.nim
Server: started. Listening to new connections on port <span class="token number">5555</span><span class="token punctuation">..</span>.
Server: client connected
Server: client connected
Server: received from client: Hello
Server: received from client: Hola
Server: received from client: Foo
Server: received from client: Bar
Server: received from client:
Server: client disconnected
</code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span></span>nim c -r client.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555
<span class="token operator">&gt;</span> Hello
<span class="token operator">&gt;</span> Foo
<span class="token operator">&gt;</span></code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span></span>nim c -r client.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555
<span class="token operator">&gt;</span> Hola
<span class="token operator">&gt;</span> Bar
<span class="token operator">&gt;</span></code></pre></div><p>Yay! We have it now. Our server accepts and receives messages from multiple clients. We have also managed client disconnections. What our server should do now is send messages from one client to other clients, which a chat server should do. Let’s do it.</p><p>There’s a major catch here. Since sending and receiving messages is a simultaneous process, we would need some kinda GUI to handle these tasks asynchronously. Just think of it, suppose you are a client chatting on our server, you wouldn’t receive any messages until you input a message because the <code class="language-text">stdin.readLine()</code> will block all the code until the user hits <kbd>Enter</kbd>.</p><p>We can build a small GUI or use <a href="https://www.linuxjournal.com/content/getting-started-ncurses"><code class="language-text">ncurses</code></a> to do that interactively in terminal. Since both of these are outside the scope of this tutorial, we’ll make a hack for now. We’ll create two different types of clients - one for sending messages and one for receiving. We call them <code class="language-text">client_sending.nim</code> and <code class="language-text">client_receiving.nim</code> respectively. <code class="language-text">client_sending.nim</code> is exactly same as our <code class="language-text">client.nim</code>.</p><div class="gatsby-code-title">client_sending.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">let</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token operator">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Client: connected to server on address 127.0.0.1:5555&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  stdout<span class="token operator">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> message<span class="token operator">:</span> string <span class="token operator">=</span> stdin<span class="token operator">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  client<span class="token operator">.</span><span class="token function">send</span><span class="token punctuation">(</span>message <span class="token operator">&amp;</span> <span class="token string">&quot;\r\L&quot;</span><span class="token punctuation">)</span>

client<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><div class="gatsby-code-title">client_receiving.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net

<span class="token keyword">let</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token operator">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Client: connected to server on address 127.0.0.1:5555&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  <span class="token keyword">let</span> receivedMessage<span class="token operator">:</span> string <span class="token operator">=</span> client<span class="token operator">.</span><span class="token function">recvLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Message: &quot;</span><span class="token punctuation">,</span> receivedMessage<span class="token punctuation">)</span>

client<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>We would need some minor changes in our <code class="language-text">server.nim</code>. Once the server receives a message, it will send it to all connected clients, except the one who sent the message.</p><div class="gatsby-code-title">server.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> net
<span class="token keyword">import</span> nativesockets

<span class="token keyword">var</span> server<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">setSockOpt</span><span class="token punctuation">(</span>OptReuseAddr<span class="token punctuation">,</span> true<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">setBlocking</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">bindAddr</span><span class="token punctuation">(</span><span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: started. Listening to new connections on port 5555...&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> clients<span class="token operator">:</span> seq<span class="token punctuation">[</span>Socket<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  <span class="token keyword">try</span><span class="token operator">:</span>
    <span class="token keyword">var</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Socket<span class="token punctuation">)</span>
    server<span class="token operator">.</span><span class="token function">accept</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    clients<span class="token operator">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client connected&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">except</span> OSError<span class="token operator">:</span>
    <span class="token keyword">discard</span>

  <span class="token keyword">var</span> clientsToRemove<span class="token operator">:</span> seq<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">for</span> index<span class="token punctuation">,</span> client <span class="token operator">in</span> clients<span class="token operator">:</span>
    <span class="token keyword">try</span><span class="token operator">:</span>
      <span class="token keyword">let</span> message<span class="token operator">:</span> string <span class="token operator">=</span> client<span class="token operator">.</span><span class="token function">recvLine</span><span class="token punctuation">(</span>timeout <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> message <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token operator">:</span>
        clientsToRemove<span class="token operator">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
        <span class="token keyword">continue</span>

      <span class="token keyword">for</span> receivingClient <span class="token operator">in</span> clients<span class="token operator">:</span>
        <span class="token keyword">if</span> receivingClient <span class="token operator">==</span> client<span class="token operator">:</span>
          <span class="token keyword">continue</span>

        receivingClient<span class="token operator">.</span><span class="token function">send</span><span class="token punctuation">(</span>message <span class="token operator">&amp;</span> <span class="token string">&quot;\r\L&quot;</span><span class="token punctuation">)</span>

      stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: received from client: &quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token keyword">except</span> TimeoutError<span class="token operator">:</span>
        <span class="token keyword">discard</span>

  <span class="token keyword">for</span> index <span class="token operator">in</span> clientsToRemove<span class="token operator">:</span>
    clients<span class="token operator">.</span><span class="token function">del</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
    stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client disconnected&quot;</span><span class="token punctuation">)</span>

server<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>Open three terminals - one for <code class="language-text">server.nim</code>, one for <code class="language-text">client_receiving.nim</code> and one for <code class="language-text">client_sending.nim</code> - and execute the respective files. Try sending some messages from sending client and see if you get those in the receiving client.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span><span></span><span></span></span>nim c -r server.nim
Server: started. Listening to new connections on port <span class="token number">5555</span><span class="token punctuation">..</span>.
Server: client connected
Server: client connected
Server: received from client: Hello
Server: received from client: How are you?
Server: received from client: What are you doing?</code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span><span></span></span>nim c -r client_sending.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555
<span class="token operator">&gt;</span> Hello
<span class="token operator">&gt;</span> How are you?
<span class="token operator">&gt;</span> What are you doing?
<span class="token operator">&gt;</span></code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span></span>nim c -r client_receiving.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555
Message: Hello
Message: How are you?
Message: What are you doing?</code></pre></div><p>You can open multiple terminals with <code class="language-text">client_receiving.nim</code> and <code class="language-text">client_sending.nim</code> and send messages to one another. You would observer that all receiving clients receive messages from all sending clients. This is because our server is current broadcasting all messages to everyone. We can limit this behavior, but we can skip that for now.</p><p>With this, you have completed a simple chat server with somewhat hacky clients (we’ll fix that later). However, if you’re working on a laptop, you would have noticed the noise of your CPU fan every time you run the server. If you’re curious enough, check the output of <code class="language-text">top</code> command and you’ll notice that the server process is taking up some chunk of CPU.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <a class="gatsby-resp-image-link" href="/static/b26e43f5726ec40d2776c236a918f61f/29114/server-cpu-usage-2.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:16%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAlElEQVQI143IsQqDMBSFYd//iRyyiNJCQTEknVwFNTc0ICTGqCetodK1w8d/7s0U0T4pFcdpwjCOeBmDeZ5hnYO1Ft57rOuauO/v3D4E+H2DCyuWLSRucch40xyibaPgHGcl58nQ91FrHYko9drXTZqiOtGvxpiY3Rk76rKMN8bwKArUVYUiz9F8+pQS8k9CCHRdhzf+SNpwGUlNbwAAAABJRU5ErkJggg==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="server cpu usage 2" title="server cpu usage 2" src="/static/b26e43f5726ec40d2776c236a918f61f/00d43/server-cpu-usage-2.png" srcSet="/static/b26e43f5726ec40d2776c236a918f61f/63868/server-cpu-usage-2.png 250w,/static/b26e43f5726ec40d2776c236a918f61f/0b533/server-cpu-usage-2.png 500w,/static/b26e43f5726ec40d2776c236a918f61f/00d43/server-cpu-usage-2.png 1000w,/static/b26e43f5726ec40d2776c236a918f61f/aa440/server-cpu-usage-2.png 1500w,/static/b26e43f5726ec40d2776c236a918f61f/29114/server-cpu-usage-2.png 1920w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><p>It seems our code needs some fixing. Indeed it does. The way we are handling new connections and incoming messages on our server is very inefficient. We are persistently asking the socket for new connection and a new message, that too in an infinite loop. If socket was an actual person, it would mean as if we are pestering him every now and then for new information.</p><p>We have a solution for this. We’ll make use of something that is core of lot of chat servers and surprisingly available on all platforms - <a href="http://man7.org/linux/man-pages/man2/select.2.html"><code class="language-text">select</code></a>.</p><h1>IV. Using <code class="language-text">select</code> for optimization</h1><p>Of all the amazing things that happened in Unix world, one was <code class="language-text">select</code>. Originally appeared in BSD, <code class="language-text">select</code> was quickly adopted in other popular OS. It’s a kernel level utility which tells us which file descriptors are ready to be read, written or have an error condition. It does this using low-level file monitoring and interrupts, instead of iterating through all files and repeatedly checking if they have changed. This is cleaner, efficient and puts minimal load on our CPU.</p><h2>How to use <code class="language-text">select</code> with our chat server?</h2><p>Since all connected clients are nothing but file descriptors, we’ll tell <code class="language-text">select</code> to monitor these given file descriptors and notify us when there’s any data on them that is yet to be read. Once <code class="language-text">select</code> notifies us, it will give us a list of file descriptors which contain unread data. We’ll iterate over these and see what data they have. Remember, when a socket receives data, it essentially means that it has data to be read.</p><p><code class="language-text">select</code> in Nim is a part of <code class="language-text">selectors</code> package. It has two important methods of our concern - <a href="https://nim-lang.org/docs/selectors.html#registerHandle,Selector%5BT%5D,,set%5BEvent%5D,T"><code class="language-text">registerHandle</code></a> and <a href="https://nim-lang.org/docs/selectors.html#select,Selector%5BT%5D,int"><code class="language-text">select</code></a>. <code class="language-text">registerHandle</code> takes in a file descriptor, the events we want to listen to (read, write, error) and optional data that we wish to receive when the event is triggered. <code class="language-text">select</code> takes in the timeout period until which it will wait for events on the registered handles (file descriptors). If we want <code class="language-text">select</code> to block our code, we can set timeout as <code class="language-text">-1</code>.</p><p>Let’s dive into the code.</p><div class="gatsby-code-title">server.nim</div><div class="gatsby-highlight" data-language="nim"><pre style="counter-reset:linenumber 0" class="language-nim line-numbers"><code class="language-nim"><span class="token keyword">import</span> nativesockets
<span class="token keyword">import</span> os
<span class="token keyword">import</span> selectors

<span class="token keyword">var</span> server<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> select<span class="token operator">:</span> Selector<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newSelector[int]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">setSockOpt</span><span class="token punctuation">(</span>OptReuseAddr<span class="token punctuation">,</span> true<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">setBlocking</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">bindAddr</span><span class="token punctuation">(</span><span class="token function">Port</span><span class="token punctuation">(</span><span class="token number">5555</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: started. Listening to new connections on port 5555...&quot;</span><span class="token punctuation">)</span>

select<span class="token operator">.</span><span class="token function">registerHandle</span><span class="token punctuation">(</span>server<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Event<span class="token operator">.</span>Read<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> clients<span class="token operator">:</span> seq<span class="token punctuation">[</span>Socket<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">while</span> true<span class="token operator">:</span>
  <span class="token keyword">var</span> results<span class="token operator">:</span> seq<span class="token punctuation">[</span>ReadyKey<span class="token punctuation">]</span> <span class="token operator">=</span> select<span class="token operator">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span> result <span class="token operator">in</span> results<span class="token operator">:</span>
    <span class="token keyword">if</span> Event<span class="token operator">.</span>Read <span class="token operator">in</span> result<span class="token operator">.</span>events<span class="token operator">:</span>
      <span class="token keyword">if</span> result<span class="token operator">.</span>fd<span class="token operator">.</span>SocketHandle <span class="token operator">==</span> server<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
        <span class="token keyword">var</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Socket<span class="token punctuation">)</span>
        server<span class="token operator">.</span><span class="token function">accept</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>

        client<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">setBlocking</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span>
        select<span class="token operator">.</span><span class="token function">registerHandle</span><span class="token punctuation">(</span>client<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>Event<span class="token operator">.</span>Read<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        clients<span class="token operator">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
        stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client connected&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">else</span><span class="token operator">:</span>
        <span class="token keyword">var</span> sourceClient<span class="token operator">:</span> Socket <span class="token operator">=</span> <span class="token function">newSocket</span><span class="token punctuation">(</span>result<span class="token operator">.</span>fd<span class="token operator">.</span>SocketHandle<span class="token punctuation">)</span>
        <span class="token keyword">var</span> message <span class="token operator">=</span> sourceClient<span class="token operator">.</span><span class="token function">recvLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> message <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token operator">:</span>
          <span class="token keyword">var</span> clientsToRemove<span class="token operator">:</span> seq<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

          <span class="token keyword">for</span> index<span class="token punctuation">,</span> client <span class="token operator">in</span> clients<span class="token operator">:</span>
            <span class="token keyword">if</span> client<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> sourceClient<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
              clientsToRemove<span class="token operator">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>

          <span class="token keyword">for</span> index <span class="token operator">in</span> clientsToRemove<span class="token operator">:</span>
            <span class="token keyword">var</span> client<span class="token operator">:</span> Socket <span class="token operator">=</span> clients<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
            select<span class="token operator">.</span><span class="token function">unregister</span><span class="token punctuation">(</span>result<span class="token operator">.</span>fd<span class="token punctuation">)</span>
            clients<span class="token operator">.</span><span class="token function">del</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
            stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: client disconnected&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token operator">:</span>
          stdout<span class="token operator">.</span><span class="token function">writeLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server: received from client: &quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>

          <span class="token keyword">for</span> client <span class="token operator">in</span> clients<span class="token operator">:</span>
            <span class="token keyword">if</span> client<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> sourceClient<span class="token operator">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
              <span class="token keyword">continue</span>

            client<span class="token operator">.</span><span class="token function">send</span><span class="token punctuation">(</span>message <span class="token operator">&amp;</span> <span class="token string">&quot;\r\L&quot;</span><span class="token punctuation">)</span>

select<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token operator">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h4>Explanation</h4><blockquote><p><strong>2-3</strong> Import the packages required for <code class="language-text">select</code> functions. Note that we also imported <code class="language-text">os</code> package. This is because, in Nim v0.18 and lower, <code class="language-text">OSErrorCode</code> is not explicity imported in the <code class="language-text">select</code> library. This is fixed in later versions.</p><p><strong>6</strong> We define our selector. It requires a type too. This would be the type of the data that we will associate in <code class="language-text">registerHandle</code> method.</p><p><strong>13</strong> Register our server for read events. Note that read events on server socket would be incoming socket connections. Since we don’t have any data associated with our server, we’ll pass data as <code class="language-text">-1</code>.</p><p><strong>17</strong> <code class="language-text">select</code> returns a list of events along with their file descriptors for which the specified event was triggered.</p><p><strong>20</strong> We are only interested in read events.</p><p><strong>21</strong> The result received from <code class="language-text">select</code> method contains the list of <code class="language-text">events</code> that were captured and the file descriptor <code class="language-text">fd</code> for which the event was triggered. Though our <code class="language-text">fd</code> is enough, we compare the underlying socket for that file descriptor. If the one that triggered a read event was our server, it must mean that we recevied an incoming connection from a client.</p><p><strong>25</strong> Since clients are also handled by <code class="language-text">select</code> we’ll set them as non-blocking.</p><p><strong>26</strong> Just like our server, listen to read events of our client. Read event on a connected socket indicates that a new message has been arrived waiting to be read.</p><p><strong>29</strong> If the read event was not triggered by server, then it must be client. This means we received a message from a client which we have to broadcast to other clients.</p><p><strong>30</strong> Working with higher-level socket abstractions is easier. So, we convert our low-level socket from file descriptor in the result into a higher-level socket.</p><p><strong>33-44</strong> If a client is disconnected, remove it from clients list and <a href="https://nim-lang.org/docs/selectors.html#unregister,Selector%5BT%5D,"><code class="language-text">unregister</code></a> events for that client.</p><p><strong>29</strong> We could have compared the two objects directly. But since the newly created <code class="language-text">sourceClient</code> object as a copy, it’s identity would be different. This would cause an inequality even though the underlying sockets are same.</p><p><strong>54</strong> Like sockets, even select should be closed to signal the kernel that we are no longer listening to any events. This is a good practice to cleanly close everything before shutting down our program.</p></blockquote><p>Let’s run the program now and see our CPU usage.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span><span></span><span></span></span>nim c -r server.nim
Server: started. Listening to new connections on port <span class="token number">5555</span><span class="token punctuation">..</span>.
Server: client connected
Server: client connected
Server: received from client: Hello
Server: received from client: How are you?
Server: received from client: <span class="token keyword">select</span> seems to be doing great</code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span><span></span></span>nim c -r client_sending.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555
<span class="token operator">&gt;</span> Hello
<span class="token operator">&gt;</span> How are you?
<span class="token operator">&gt;</span> <span class="token keyword">select</span> seems to be doing great
<span class="token operator">&gt;</span></code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="command-line-prompt"><span data-user="tejas" data-host="localhost"></span><span></span><span></span><span></span><span></span></span>nim c -r client_receiving.nim
Client: connected to server on address <span class="token number">127.0</span>.0.1:5555
Message: Hello
Message: How are you?
Message: <span class="token keyword">select</span> seems to be doing great</code></pre></div><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <a class="gatsby-resp-image-link" href="/static/cb4a8458040c7980316da20da7f192d3/29114/low-cpu-server.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:21.2%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAiklEQVQY053OPQvDIBAGYP//fxJJlgYcxI9OkjEkNoqIQqbwJgp16FBoDx7uhuPuJVJKVEqp3rXWWJYFIQR477t935v3/PoQYwQZxxHTNGEYBjzuzjkHYwyU0jYLIWCM+ep5qyGstSD1W0oJ67r2JPM8Y9s2/FPkOA7knFvcerhyzqGU0hbO8/zJBctyKatxtPVQAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="low cpu server" title="low cpu server" src="/static/cb4a8458040c7980316da20da7f192d3/00d43/low-cpu-server.png" srcSet="/static/cb4a8458040c7980316da20da7f192d3/63868/low-cpu-server.png 250w,/static/cb4a8458040c7980316da20da7f192d3/0b533/low-cpu-server.png 500w,/static/cb4a8458040c7980316da20da7f192d3/00d43/low-cpu-server.png 1000w,/static/cb4a8458040c7980316da20da7f192d3/aa440/low-cpu-server.png 1500w,/static/cb4a8458040c7980316da20da7f192d3/29114/low-cpu-server.png 1920w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span><p>It’s not even showing in the top CPU consuming processes. That’s great.</p><hr/><p>With this we complete our basic chat server. I know clients are still messy, but for that, we would need to dive deep into the interactivity part which is beyond the scope of this tutorial. Next up, we can add clients with identity information so that server can uniquely tag who sent which message, 1:1 messaging instead of group messaging and an interactive UI. I might write a follow-up article with all of these in future.</p><p>Nim is an amazing language. To be able to do so much, in so little and clean code is amazing. We haven’t touched on code optimization yet, but I believe we can use some micro-optimizations to make this code even faster. It’s been a great exercise for me to move away from Python and learn interesting languages like Nim.</p><p>Let me know about your feedback. If you feel there were any issues with the tutorial, or writing style, or any errors in text or code, or any difficulty in understanding, or if you just wanna give a compliment, leave your comments below.</p><hr style="margin-bottom:1.2rem"/><div shortname="tejasjadhav" config="[object Object]" id="disqus_thread"></div><footer><div style="display:flex;margin-bottom:3rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.6rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAFRUlEQVQ4y22Se1CNaRjAv9gs1mgMy0hhrCR3XaR0XxopmVSqQ1lOytkSKdWWOimhiy7ndL+RpMtJotJVdCq2ENZtjEXsbrSWsWutP8zsb7/O8s/OfjO/7/2+5/3e3/e8z/MK5vI8HG2smGc4Hx0dHcaNG4e29meM0tLSoKUlIAiCOIrvo7QYrWGUBn19fZycnAgMDOTDhw+MXMJPL4Zx9/BAV1dXs/D/+CT9L1+MH4+xsTGurq6oamr4e0Q4NDSEj0SCnZ0dU6dO1XzoYrkcD1szrBYboP/lJE3MQG8aktUrkXxtTqjnWkwN52ji+np6mJqZocjJ/TfDy91qXJzW4ujoyOQpU/hcezR9BQkMVqdx93giXVmRJEk3os6K4mHFEe4cS+TXszlcUuxn7BhtJk6YwCJLW0ISU3jy9CnCs3cfWBMQip2NtfhHLdysTXl+JpsbRfEMiNwWBQ/KD/FDaQLXCuRcL5RzqySRP1qKCfNap8ly2pTJLLRZjUFhF8KKnrdM8pezyOArBK3R7PNxZrAmg4ZDIfRkR6NWRHH543hNlI1kXH8wmGeqTKTOdhrh7KmTmeX1LTMv/I4ws+01+vldGFrYaiY97c3JkHnhI9Zwi/0KQjbY0SPKqmMD2GxrjKeVMVJHS2rkQTiYLNSsMTIywiClljkdbxDmtgwzu/Mty7z8GS1ObvXy4E5fL+nJRyjNzaG2SMEakwUEebvSWF1BYbaS4yUlXG9vwHSREWNHhFtDmXXpPV81vxCFrcNMqxvENyiYxdN1cLBeBX++oqayks62NnobasjZ5U1eVCAvnz2ivbmZy2o1Qzd6maQzkU3m81kTcwTdtjcYtL1CMOx8x4yO92wNj2LPOkvWWixHGSYlOdSftLAAFLt9uZC8l47UvaQFbyF5j5SjoVIOyyTYi1tO2eaBibdYrgh/5px7jDA5NZNJhVUsPVCM3N2e49GBmg5fUUZxqyhOrNVOckXpvbIkBsSm9OdGa+jLj0UZ7E2Eux2jnOcheOgyvahOrOkm8YBKjJiYXoSzLIx4v408rkqnvyCWlpS9HAv3pWSPhJoYKbXxMi5mRHL/RBJdSjkyyRaMd0WgtcOBCZEy9BqHEbQDnRnjtxTB25S5iRtwj19KbUIIV/PjOBntT0FCJBXZaeSlJpESLuNE9HbuFyewZ+825iTvx6QqD9lRP1yL4zBTlSIElO0gIE+U7TbFs2AFcd22BCZZURYhE7cYT2v2AQrj96FKjmHg2EG606OJkG7AKdGULSUWeGYtwTfLFJ+sZWxSLEaIaVrJd602HKizIvaCHUGnjfmmYj4OUj1Sd3px8Wg4xeKWWw7vQiUPxm/jClbHzMAlw4i1KUtxz7NhfZYl6xWrcMm0Qgg/b0t4ozUR7bb4KZcRmRxAfnkqSYVxuDpaoQzyoXDfdpRiY+SbnXHzcSH/VAbF5QpCDmzDLWUJ28qskJVZEFlrIXa7yZroNnsCKpZwSBHDwyevuf14iBs/viA1U0H8djcygiVkisTu9KW8voU7gy+5PficF8//Ii5tM8U9i1ENWFJ7wxwhrMGaqA4HfBQLaGppouv2A040X0DV2UOdup/cqnpSC0pILy2n7HwnZ7r7qe7opqShlcfDbyg/pSS72YDam6s41S8K83ssyOu3YXeJEfWN9XTfeYjqYi9n1H3UdX1P45UBmvpuidzkbM9VTeysKK3sUPPwl1ecrMoVhYYaYeVVUVgt3s7dXUVKlQGNzefovfeIGjG7EeEn6elLV6gbQXweidV391HZrubBz79RXpmjEao+Cv8BGzWyHVUDvLMAAAAASUVORK5CYII=" alt="Tejas Jadhav" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/bdbd30996dacf8129992301790511b07/8ba1e/profile-pic.png 1x,
/static/bdbd30996dacf8129992301790511b07/f937a/profile-pic.png 1.5x,
/static/bdbd30996dacf8129992301790511b07/71eb7/profile-pic.png 2x" /><img loading="lazy" width="50" height="50" srcset="/static/bdbd30996dacf8129992301790511b07/8ba1e/profile-pic.png 1x,
/static/bdbd30996dacf8129992301790511b07/f937a/profile-pic.png 1.5x,
/static/bdbd30996dacf8129992301790511b07/71eb7/profile-pic.png 2x" src="/static/bdbd30996dacf8129992301790511b07/8ba1e/profile-pic.png" alt="Tejas Jadhav" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>Tejas Jadhav</strong> <!-- -->full time software engineer</p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/common-database-table-designs/">← <!-- -->Common database table design patterns</a></li><li></li></ul></nav></main><footer>© <!-- -->2021<!-- --> Tejas Jadhav</footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-89679997-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/simple-chat-server-in-nim-using-sockets/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-fc4d0f0a2c7f65435551.js"],"component---src-pages-404-js":["/component---src-pages-404-js-e8115d276c12f97c783c.js"],"component---src-pages-index-js":["/component---src-pages-index-js-af44e365573a27d3ab16.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-0de9500dca1e6e690244.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-0de9500dca1e6e690244.js" async=""></script><script src="/d5d7a013bc6c1e2b6d7db819052c16d7efea5559-baf100a1121eb9646ed4.js" async=""></script><script src="/app-fc4d0f0a2c7f65435551.js" async=""></script><script src="/styles-1c3c06048fccead674b8.js" async=""></script><script src="/framework-c88d07efb40e009babfb.js" async=""></script><script src="/webpack-runtime-90fe9894775700252564.js" async=""></script></body></html>